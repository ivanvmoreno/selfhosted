version: "3.7"

services:
  nginx:
    image: nginx
    depends_on:
      - letsencrypt
      - syncthing
      - bitwarden
      - ffsync
      - wekan
      - bookstack
    networks:
      - front
    volumes:
      - le-certificates:/etc/nginx/certs
      - ./reverse-proxy.conf:/etc/nginx/conf.d/reverse-proxy.conf
    ports:
      - 80:80
      - 443:443

  letsencrypt:
    image: linuxserver/letsencrypt
    cap_add:
      - NET_ADMIN
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - URL=ivan.build
      - SUBDOMAINS=sync,pass,mail,ffsync,boards,wiki
      - VALIDATION=dns
      - DNSPLUGIN=cloudflare
      - EMAIL=${LE_EMAIL}
    volumes:
      - ./cloudflare.ini:/config/dns-conf/cloudflare.ini
      - le-certificates:/config/etc/letsencrypt

  syncthing:
    image: linuxserver/syncthing:v1.4.0-ls28
    container_name: syncthing
    networks:
      front:
        aliases:
          - syncthing
    environment:
      PUID: "1000"
      PGID: "1000"
      TZ: "Europe/London"
      UMASK_SET: "022"
    volumes:
      - ~/Sync:/config
      - /data1:/data1
      - /data2:/data2
    ports:
      - 22000:22000
      - 21027:21027/udp

  bitwarden:
    image: bitwardenrs/server
    networks:
      front:
        aliases:
          - bitwarden
    environment:
      WEBSOCKET_ENABLED: 'true'
      SIGNUPS_ALLOWED: 'false'
    volumes:
      - /opt/bw-data:/data
    ports:
      - 3012:3012

  ffsync:
    image: syncserver
    networks:
      front:
        aliases:
          - ffsync
    environment:
      - SYNCSERVER_PUBLIC_URL=https://ffsync.ivan.build
      - SYNCSERVER_SECRET=${FFSYNC_SECRET}
      - SYNCSERVER_SQLURI=sqlite:////data/syncserver.db
      - SYNCSERVER_BATCH_UPLOAD_ENABLED=true
      - SYNCSERVER_FORCE_WSGI_ENVIRON=true
      - SYNCSERVER_ALLOW_NEW_USER=true
      - PORT=5000
    volumes:
      - /opt/ffsync-data/:/data
    ports:
      - 5000

  wekan-db:
    image: mongo:3.2.21
    command: mongod --smallfiles --oplogSize 128
    networks:
      wekan-internal:
        aliases:
          - wekan-db
    volumes:
      - /opt/wekan-data:/data/db
      - /opt/wekan-data/dump:/dump
    ports:
      - 27017

  wekan:
    image: quay.io/wekan/wekan:master
    depends_on:
      - wekan-db
    networks:
      wekan-internal:
      front:
        aliases:
          - wekan
    environment:
      - MONGO_URL=mongodb://wekan-db:27017/wekan
      - ROOT_URL=https://boards.ivan.build
      - WITH_API=true
      - ACCOUNTS_LOCKOUT_KNOWN_USERS_FAILURES_BEFORE=3
      - ACCOUNTS_LOCKOUT_KNOWN_USERS_PERIOD=60
      - ACCOUNTS_LOCKOUT_KNOWN_USERS_FAILURE_WINDOW=15
      - ACCOUNTS_LOCKOUT_UNKNOWN_USERS_FAILURES_BERORE=3
      - ACCOUNTS_LOCKOUT_UNKNOWN_USERS_LOCKOUT_PERIOD=60
      - ACCOUNTS_LOCKOUT_UNKNOWN_USERS_FAILURE_WINDOW=15
      - BROWSER_POLICY_ENABLED=true

  bookstack-db:
    image: linuxserver/mariadb
    networks:
      bookstack-internal:
        aliases:
          - bookstack-db
    environment:
      - PUID=1000
      - PGID=1000
      - MYSQL_ROOT_PASSWORD=${BOOKSTACK_DB_PASS_ROOT}
      - TZ=Europe/London
      - MYSQL_DATABASE=bookstackapp
      - MYSQL_USER=bookstack
      - MYSQL_PASSWORD=${BOOKSTACK_DB_PASS}
    volumes:
      - /opt/bookstack-data:/config

  bookstack:
    image: linuxserver/bookstack
    depends_on: 
      - bookstack-db
    networks:
      bookstack-internal:
      front:
        aliases:
          - bookstack
    environment:
      - APP_URL=https://wiki.ivan.build
      - PUID=1000
      - PGID=1000
      - DB_HOST=bookstack-db
      - DB_USER=bookstack
      - DB_PASS=${BOOKSTACK_DB_PASS}
      - DB_DATABASE=bookstackapp
    volumes:
      - /opt/bookstack-data:/config

networks:
  front:
  wekan-internal:
  bookstack-internal:

volumes:
  le-certificates:
    driver: local
    driver_opts:
      type: nfs
      o: bind
      device: /config/etc/letsencrypt